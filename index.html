<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengambilan Barang</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-color: #64748b;
            --secondary-hover: #475569; --bg-gradient-start: #6a11cb; --bg-gradient-end: #2575fc;
            --card-bg: #ffffff; --text-dark: #0f172a; --text-light: #f8fafc;
            --text-muted: #64748b; --border-color: #e2e8f0; --success-color: #16a34a;
            --error-color: #dc2626;
        }
        body {
            font-family: 'Inter', sans-serif; margin: 0; color: var(--text-dark);
            background-color: var(--text-dark); /* BG dasar */
        }

        /* Container untuk background Vanta.js */
        #vanta-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0; /* Diletakkan di stack paling bawah */
        }
        
        .page-container {
            width: 100%; min-height: 100vh; padding: 2rem 1rem;
            display: none; justify-content: center; align-items: center; box-sizing: border-box;
            flex-direction: column; 
            gap: 2rem; 
            position: relative;
            z-index: 1;
        }
        .page-container.active { display: flex; }
        #loginPage { background: none; }
        .login-box {
            background-color: rgba(31, 41, 55, 0.85); backdrop-filter: blur(10px);
            padding: 2.5rem; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3), 0 10px 10px -5px rgba(0,0,0,0.1);
            width: 100%; max-width: 420px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .logo-container { margin-bottom: 1.5rem; }
        .logo-container img { max-width: 110px; height: auto; }
        .login-box h2 { font-size: 1.75rem; font-weight: 700; color: var(--text-light); margin: 0 0 0.5rem 0; }
        .login-box p { margin: 0 0 2rem 0; color: #cbd5e1; }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #cbd5e1; }
        .input-group input {
            width: 100%; padding: 0.75rem 1rem; background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; box-sizing: border-box;
            color: var(--text-light); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input::placeholder { color: #94a3b8; }
        .input-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); }
        .role-selector { display: flex; gap: 0.5rem; background-color: rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; }
        .role-selector label {
            flex: 1; padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer;
            transition: all 0.2s; display: flex; justify-content: center;
            align-items: center; gap: 0.5rem; color: #cbd5e1; border: 1px solid transparent;
        }
        .role-selector input[type="radio"] { display: none; }
        .role-selector input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--text-light); font-weight: 600; }
        button, .logout-btn, .btn-link {
            width: 100%; padding: 0.875rem; background-color: var(--primary-color); color: white;
            border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: inline-flex;
            justify-content: center; align-items: center; gap: 0.5rem; text-decoration: none;
            font-family: 'Inter', sans-serif;
        }
        button:hover, .logout-btn:hover, .btn-link:hover { background-color: var(--primary-hover); }
        button:active, .logout-btn:active, .btn-link:active { transform: scale(0.98); }
        button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .card { background-color: var(--card-bg); padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); width: 100%; }
        .form-box { max-width: 550px; }
        .dashboard-box { max-width: 1200px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .header h2 { margin: 0; font-size: 1.5rem; color: var(--text-dark); }
        .logout-btn { background-color: var(--secondary-color); width: auto; padding: 0.5rem 1rem; }
        .logout-btn:hover { background-color: var(--secondary-hover); }
        .form-box .input-group input, .form-box textarea, .dashboard-box .input-group input, .dashboard-box .input-group select,
        .settings-box .input-group input { 
            color: var(--text-dark); background-color: #fff; border: 1px solid #cbd5e1; 
        }
        .form-box .input-group input:focus, .form-box textarea:focus, .dashboard-box .input-group input:focus, .dashboard-box .input-group select:focus,
        .settings-box .input-group input:focus { 
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); 
        }
        .settings-box .input-group label {
            color: var(--text-dark); /* Label gelap di card putih */
        }
        .signature-pad-container { border: 2px dashed var(--border-color); border-radius: 0.5rem; height: 200px; touch-action: none; position: relative; }
        .signature-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; }
        
        #signature-pad { width: 100%; height: 100%; }
        
        button.secondary-btn, .btn-link.secondary-btn { background-color: var(--secondary-color); margin-top: 1rem; }
        button.secondary-btn:hover, .btn-link.secondary-btn:hover { background-color: var(--secondary-hover); }
        .status { text-align: center; margin-top: 1.5rem; height: 1.25rem; font-weight: 600; }
        .error { color: var(--error-color); text-align: center; margin-top: 1rem; height: 1.25rem; font-weight: 500;}
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 0.75rem; }
        #dataTable { width: 100%; border-collapse: collapse; }
        #dataTable th, #dataTable td { padding: 0.75rem 1rem; text-align: left; white-space: nowrap; }
        #dataTable th { background-color: #f1f5f9; color: var(--text-dark); font-weight: 600; border-bottom: 1px solid var(--border-color); }
        #dataTable td { border-bottom: 1px solid var(--border-color); }
        #dataTable tbody tr:last-child td { border-bottom: none; }
        #dataTable tbody tr:hover { background-color: #f8fafc; }
        #dataTable .signature-img { max-width: 100px; height: auto; border-radius: 4px; }
        
        .edit-btn, .delete-btn {
            width: auto; padding: 0.375rem 0.75rem; font-size: 0.875rem;
            color: white; border: none; border-radius: 0.5rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-btn { background-color: #f59e0b; }
        .edit-btn:hover { background-color: #d97706; }
        .delete-btn { background-color: var(--error-color); }
        .delete-btn:hover { background-color: #b91c1c; }
        .action-buttons { display: flex; gap: 0.5rem; }

        .filter-section, .download-section, .settings-box { 
            padding: 1.5rem; border: 1px solid var(--border-color); 
            border-radius: 0.75rem; margin-bottom: 1.5rem; background-color: #f8fafc; 
        }
        .filter-section h3, .download-section h3, .settings-box h3 { 
            margin-top: 0; margin-bottom: 1rem; font-size: 1.125rem; 
        }
        #searchForm { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        #searchForm .input-group { margin-bottom: 0; flex: 1; min-width: 200px; }
        #searchForm button { width: auto; padding: 0.75rem 1.5rem; }
        .download-section .button-group { display: flex; flex-wrap: wrap; gap: 1rem; }
        .download-section button, .download-section .btn-link { width: auto; padding: 0.75rem 1.5rem; margin-top: 0; }
        
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); 
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal .card { max-width: 500px; position: relative; margin: 1rem; }
        
        #editModal .input-group label, #forgotPasswordModal .input-group label { color: var(--text-dark); }
        #editModal .input-group input, #forgotPasswordModal .input-group input { 
            color: var(--text-dark); background-color: #fff; border: 1px solid #cbd5e1; 
        }
        #editModal .input-group input:focus, #forgotPasswordModal .input-group input:focus { 
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); 
        }
        
        .close-btn { 
            position: absolute; top: 1rem; right: 1.5rem; 
            font-size: 2rem; cursor: pointer; color: #9ca3af; 
            line-height: 1;
        }

        #forgotPasswordLink {
            color: #cbd5e1;
            text-decoration: none;
            margin-top: 1.5rem;
            display: inline-block;
        }
        #forgotPasswordLink:hover {
            color: var(--text-light);
            text-decoration: underline;
        }

        .loader-container {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            justify-content: center; align-items: center;
        }
        .loader-container.active { display: flex; }
        .loader-spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="vanta-background"></div>

    <div id="loader-overlay" class="loader-container">
        <div class="loader-spinner"></div>
    </div>

    <div id="loginPage" class="page-container active">
        <div class="login-box">
            <div class="logo-container"><img src="logo.png" alt="Logo Instansi"></div>
            <h2>Sistem Pengambilan Barang</h2>
            <p>Mahkamah Syar'iyah Simpang Tiga Redelong</p>
            <form id="loginForm">
                <div class="input-group">
                    <label>Login Sebagai</label>
                    <div class="role-selector">
                        <input type="radio" id="rolePegawai" name="role" value="pegawai" checked>
                        <label for="rolePegawai"><i class="fa-solid fa-user"></i>Pegawai</label>
                        <input type="radio" id="rolePengawas" name="role" value="pengawas">
                        <label for="rolePengawas"><i class="fa-solid fa-user-shield"></i>Pengawas</label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="password">
                </div>
                <button type="submit"><i class="fa-solid fa-right-to-bracket"></i>Login</button>
                <p id="error-message" class="error"></p>
                <a href="#" id="forgotPasswordLink">Lupa Password?</a>
            </form>
        </div>
    </div>

    <div id="pegawaiPage" class="page-container">
        <div class="card form-box">
            <div class="header">
                <h2>Sistem Pengambilan Barang</h2>
                <a class="logout-btn"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a>
            </div>
            <form id="itemForm">
                <div class="input-group"><label for="namaPegawai">Nama Pegawai</label><input type="text" id="namaPegawai" required></div>
                <div class="input-group"><label for="nipPegawai">NIP Pegawai</label><input type="text" id="nipPegawai" required></div>
                <div class="input-group"><label for="namaBarang">Nama Barang</label><input type="text" id="namaBarang" required></div>
                <div class="input-group"><label for="jumlahBarang">Jumlah</label><input type="number" id="jumlahBarang" required></div>
                <div class="input-group"><label for="tanggal">Tanggal Pengambilan</label><input type="date" id="tanggal" required></div>
                <div class="input-group"><label for="waktu">Waktu</label><input type="time" id="waktu" required></div>
                <div class="input-group">
                    <label>Tanda Tangan Penerima</label>
                    <div class="signature-pad-container">
                        <canvas id="signature-pad"></canvas>
                        <span class="signature-placeholder"><i class="fa-solid fa-signature"></i> Coret di area ini</span>
                    </div>
                    <button type="button" id="clear-signature" class="secondary-btn"><i class="fa-solid fa-eraser"></i> Hapus Tanda Tangan</button>
                </div>
                <button type="submit" id="submit-btn"><i class="fa-solid fa-paper-plane"></i> Kirim Data</button>
                <p id="status-message" class="status"></p>
            </form>
        </div>
    </div>
    
    <div id="pengawasPage" class="page-container">
         <div class="card dashboard-box">
            <div class="header">
                <h2>Laporan Pengambilan Barang</h2>
                <a class="logout-btn"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a>
            </div>
            <div class="filter-section">
                <h3><i class="fa-solid fa-filter"></i> Filter Data</h3>
                <form id="searchForm">
                    <div class="input-group"><label for="startDate">Dari Tanggal</label><input type="date" id="startDate"></div>
                    <div class="input-group"><label for="endDate">Sampai Tanggal</label><input type="date" id="endDate"></div>
                    <button type="submit"><i class="fa-solid fa-magnifying-glass"></i> Cari</button>
                    <button type="button" id="resetBtn" class="secondary-btn" style="margin-top:0;"><i class="fa-solid fa-rotate-left"></i> Reset</button>
                </form>
            </div>

            <div class="download-section">
                <h3><i class="fa-solid fa-download"></i> Download & Akses Cepat</h3>
                <div class="button-group">
                    <button id="downloadPdfBtn"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
                    <button id="downloadCsvBtn" class="secondary-btn"><i class="fa-solid fa-file-csv"></i> Download CSV</button>
                    
                    <a href="https://docs.google.com/spreadsheets/d/1xNG0amekgoETi6B79tGX4xXY2vX-gfWE63vEGJYt0Po/edit?usp=sharing" target="_blank" class="btn-link" style="background-color: var(--success-color);">
                        <i class="fa-solid fa-table-cells"></i> Buka Spreadsheet
                    </a>
                    <a href="https://drive.google.com/drive/folders/1Iqlyht5fBuhgvcH3_mLjw7mB2fyxKVWd?usp=sharing" target="_blank" class="btn-link" style="background-color: #f59e0b;">
                        <i class="fa-brands fa-google-drive"></i> Buka Google Drive
                    </a>
                </div>
            </div>

            <div class="settings-box">
                <h3><i class="fa-solid fa-cogs"></i> Pengaturan Akun & Keamanan</h3>
                <p id="settings-status" class="status"></p>
                
                <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
                    
                    <div style="flex: 1; min-width: 300px;">
                        <h4>Ganti Password</h4>
                        <form id="changePasswordForm">
                            <div class="input-group">
                                <label for="cpRole">Ganti Password Untuk Akun</label>
                                <select id="cpRole" required style="padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; width: 100%;">
                                    <option value="pengawas">Pengawas (Akun Anda)</option>
                                    <option value="pegawai">Pegawai</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="cpNewPassword">Password Baru</label>
                                <input type="password" id="cpNewPassword" required minlength="4" placeholder="Minimal 4 karakter">
                            </div>
                            <button type="submit"><i class="fa-solid fa-key"></i> Simpan Password Baru</button>
                        </form>
                    </div>
                    
                    <div style="flex: 1; min-width: 300px;">
                        <h4>Email Recovery (Untuk Lupa Password)</h4>
                        <form id="updateEmailsForm">
                            <div class="input-group">
                                <label for="emailPengawas">Email Akun Pengawas</label>
                                <input type="email" id="emailPengawas" placeholder="admin@email.com" required>
                            </div>
                            <div class="input-group">
                                <label for="emailPegawai">Email Akun Pegawai</label>
                                <input type="email" id="emailPegawai" placeholder="pegawai@email.com (opsional)">
                            </div>
                            <button type="submit"><i class="fa-solid fa-envelope"></i> Simpan Email Recovery</button>
                        </form>
                    </div>

                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead><tr><th>No</th><th>Nama Pegawai</th><th>NIP</th><th>Nama Barang</th><th>Jumlah</th><th>Tanggal</th><th>Waktu</th><th>Tanda Tangan</th><th>Aksi</th></tr></thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
                 <p id="table-status" style="text-align: center; padding: 2rem; color: var(--text-muted);">Memuat data...</p>
            </div>
        </div>
        </div>
    
    <div id="editModal" class="modal">
        <div class="card">
            <div class="header" style="border: none; padding-bottom: 0;">
                <h2 style="font-size: 1.25rem;">Edit Data</h2>
                <span class="close-btn" data-modal-id="editModal">&times;</span>
            </div>
            <form id="editForm" style="margin-top: 1.5rem;">
                <input type="hidden" id="editRowNumber">
                <div class="input-group"><label for="editNamaPegawai">Nama Pegawai</label><input type="text" id="editNamaPegawai" required></div>
                <div class="input-group"><label for="editNipPegawai">NIP</label><input type="text" id="editNipPegawai" required></div>
                <div class="input-group"><label for="editNamaBarang">Nama Barang</label><input type="text" id="editNamaBarang" required></div>
                <div class="input-group"><label for="editJumlahBarang">Jumlah</label><input type="number" id="editJumlahBarang" required></div>
                <div class="input-group"><label for="editTanggal">Tanggal</label><input type="date" id="editTanggal" required></div>
                <div class="input-group"><label for="editWaktu">Waktu</label><input type="time" id="editWaktu" required></div>
                <button type="submit"><i class="fa-solid fa-save"></i> Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="card">
            <div class="header" style="border: none; padding-bottom: 0;">
                <h2 style="font-size: 1.25rem;">Lupa Password</h2>
                <span class="close-btn" data-modal-id="forgotPasswordModal">&times;</span>
            </div>
            <p style="color: var(--text-muted); margin-top: 1rem;">Password baru akan dikirimkan ke email recovery yang terdaftar.</p>
            <p id="forgot-status" class="status"></p>
            <form id="forgotPasswordForm" style="margin-top: 1.5rem;">
                <div class="input-group">
                    <label for="fpRole">Pilih Akun</label>
                    <select id="fpRole" required style="padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; width: 100%;">
                        <option value="">-- Pilih Akun --</option>
                        <option value="pengawas">Pengawas</option>
                        <option value="pegawai">Pegawai</option>
                    </select>
                </div>
                <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim Password Baru</button>
            </form>
        </div>
    </div>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // GANTI SCRIPT: Inisialisasi Latar Belakang 3D VANTA.JS (GLOBE)
        document.addEventListener('DOMContentLoaded', (event) => {
            try {
                // Ambil warna dari CSS variables Anda untuk konsistensi
                const vantaColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#4f46e5';
                const vantaBgColor = getComputedStyle(document.documentElement).getPropertyValue('--text-dark').trim() || '#0f172a';
                
                VANTA.GLOBE({
                    el: "#vanta-background", // Targetkan div yang kita buat
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: vantaColor,      // Warna daratan globe (dari --primary-color)
                    color2: vantaColor,     // Warna atmosphere (opsional, disamakan)
                    backgroundColor: vantaBgColor, // Warna latar (dari --text-dark)
                    size: 1.0 // Ukuran globe
                });
            } catch (e) {
                console.error("Vanta.js gagal dimuat: ", e);
                // Fallback jika gagal, setidaknya body punya warna
                document.body.style.backgroundColor = '#0f172a';
            }
        });
    
        // === URL BARU ANDA ===
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxj7kuMefLZfRKokrWg8nMI-CDNR7sRuekA7AadTP62Gwen9Frh4HW5r1zxwnrVImti/exec';
        
        let currentData = [];
        const canvas = document.getElementById('signature-pad');
        let signaturePad;
        if (canvas) {
            signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
        }
        
        const tableBody = document.getElementById('dataTableBody');
        const tableStatus = document.getElementById('table-status');
        const loaderOverlay = document.getElementById('loader-overlay');

        function showLoading(isLoading) {
            if (isLoading) {
                loaderOverlay.classList.add('active');
            } else {
                loaderOverlay.classList.remove('active');
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-container').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function resizeCanvas() {
            if (!canvas) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
            const signaturePlaceholder = document.querySelector('.signature-placeholder');
            if (signaturePlaceholder) signaturePlaceholder.style.display = 'block';
        }

        function showModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('active', show);
            }
        }

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showModal(btn.dataset.modalId, false);
            });
        });
        
        window.onclick = (e) => { 
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            } 
        };

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            showLoading(true);
            const selectedRole = document.querySelector('input[name="role"]:checked').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = '';
            
            fetch(`${WEB_APP_URL}?action=login&role=${selectedRole}&password=${password}`)
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        sessionStorage.setItem('userRole', selectedRole);
                        if (selectedRole === 'pengawas') {
                            showPage('pengawasPage');
                            fetchDataPengawas(); 
                            loadSettings(); 
                        } else {
                            showPage('pegawaiPage');
                            setTimeout(resizeCanvas, 0); 
                        }
                    } else {
                        errorMessage.textContent = result.message || 'Kombinasi Role dan Password salah.';
                    }
                })
                .catch(err => {
                    errorMessage.textContent = 'Error: ' + err.message;
                })
                .finally(() => {
                    showLoading(false);
                });
        });

        document.querySelectorAll('.logout-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                sessionStorage.removeItem('userRole');
                document.getElementById('loginForm').reset();
                document.getElementById('error-message').textContent = '';
                showPage('loginPage');
            });
        });

        window.addEventListener("resize", resizeCanvas);

        if (canvas) {
            const signaturePlaceholder = document.querySelector('.signature-placeholder');
            signaturePad.addEventListener("beginStroke", () => {
                if (signaturePlaceholder) signaturePlaceholder.style.display = 'none';
            });
            document.getElementById('clear-signature').addEventListener('click', () => {
                signaturePad.clear();
                if (signaturePlaceholder) signaturePlaceholder.style.display = 'block';
            });
        }
        
        const itemForm = document.getElementById('itemForm');
        if (itemForm) {
            const statusMessage = document.getElementById('status-message');
            const submitBtn = document.getElementById('submit-btn');
            itemForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (signaturePad.isEmpty()) { return alert("Tanda tangan tidak boleh kosong."); }
                
                showLoading(true);
                statusMessage.textContent = 'Mengirim data...';
                statusMessage.style.color = 'orange';
                submitBtn.disabled = true;

                const signatureDataUrl = signaturePad.toDataURL('image/jpeg', 0.5);

                const dataToSend = {
                    action: "create",
                    data: {
                        "Nama Pegawai": document.getElementById('namaPegawai').value,
                        "Nip Pegawai": document.getElementById('nipPegawai').value,
                        "Nama Barang": document.getElementById('namaBarang').value,
                        "Jumlah Barang": document.getElementById('jumlahBarang').value,
                        "Tanggal Pengambilan": document.getElementById('tanggal').value,
                        "Waktu": document.getElementById('waktu').value,
                        "Tanda Tangan Penerima": signatureDataUrl
                    }
                };

                fetch(WEB_APP_URL, {
                    method: 'POST', body: JSON.stringify(dataToSend), headers: { 'Content-Type': 'text/plain;charset=utf-8' }, redirect: "follow"
                }).then(res => res.json()).then(result => {
                    if (result.success) {
                        statusMessage.textContent = 'Data berhasil dikirim!';
                        statusMessage.style.color = 'var(--success-color)';
                        itemForm.reset();
                        signaturePad.clear();
                        const placeholder = document.querySelector('.signature-placeholder');
                        if (placeholder) placeholder.style.display = 'block';
                    } else { throw new Error(result.message || 'Terjadi kesalahan.'); }
                }).catch(error => {
                    statusMessage.textContent = 'Gagal mengirim: ' + error.message;
                    statusMessage.style.color = 'var(--error-color)';
                }).finally(() => {
                    showLoading(false);
                    submitBtn.disabled = false;
                    setTimeout(() => { statusMessage.textContent = ''; }, 5000);
                });
            });
        }
        
        async function fetchDataPengawas(url = WEB_APP_URL + '?action=readAll') {
            if (!tableStatus) return;
            
            showLoading(true);
            tableStatus.textContent = "Memuat data...";
            tableStatus.style.display = 'block';
            tableBody.innerHTML = '';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    currentData = result.data;
                    displayDataPengawas(currentData);
                } else { throw new Error(result.message); }
            } catch (error) {
                tableStatus.textContent = 'Gagal memuat data: ' + error.message;
            } finally {
                showLoading(false);
            }
        }

        function displayDataPengawas(data) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableStatus.textContent = "Tidak ada data untuk ditampilkan.";
                tableStatus.style.display = 'block';
                return;
            }
            tableStatus.style.display = 'none';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const signatureUrl = item['Tanda Tangan Penerima'];
                let signatureCell = 'Tidak Ada Ttd';
                if (signatureUrl && typeof signatureUrl === 'string' && signatureUrl.includes('drive.google.com')) {
                    try {
                        const fileId = new URL(signatureUrl).searchParams.get('id');
                        if (fileId) {
                            signatureCell = `<img src="https://drive.google.com/thumbnail?id=${fileId}" alt="Tanda Tangan" class="signature-img"/>`;
                        }
                    } catch (e) { /* Biarkan default */ }
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item['Nama Pegawai']||''}</td>
                    <td>${item['Nip Pegawai']||''}</td>
                    <td>${item['Nama Barang']||''}</td>
                    <td>${item['Jumlah Barang']||''}</td>
                    <td>${item['Tanggal Pengambilan']||''}</td>
                    <td>${item['Waktu']||''}</td>
                    <td>${signatureCell}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="edit-btn" data-row='${JSON.stringify(item)}'>
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                            <button class="delete-btn" data-row-number="${item.rowNumber}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate && endDate) {
                    fetchDataPengawas(`${WEB_APP_URL}?action=searchByDate&startDate=${startDate}&endDate=${endDate}`);
                } else { alert('Silakan isi kedua tanggal untuk pencarian.'); }
            });
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchForm').reset();
                fetchDataPengawas();
            });
        }

        tableBody.addEventListener('click', function(e) {
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');

            if (editButton) {
                const item = JSON.parse(editButton.dataset.row);
                document.getElementById('editRowNumber').value = item.rowNumber;
                document.getElementById('editNamaPegawai').value = item['Nama Pegawai'];
                document.getElementById('editNipPegawai').value = item['Nip Pegawai'];
                document.getElementById('editNamaBarang').value = item['Nama Barang'];
                document.getElementById('editJumlahBarang').value = item['Jumlah Barang'];
                document.getElementById('editTanggal').value = item['Tanggal Pengambilan'];
                document.getElementById('editWaktu').value = item['Waktu'];
                showModal('editModal', true);
            }
            
            if (deleteButton) {
                const rowNumber = deleteButton.dataset.rowNumber;
                if (confirm(`Apakah Anda yakin ingin menghapus data ini? (Baris Sheet: ${rowNumber})`)) {
                    deleteData(rowNumber);
                }
            }
        });

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true);
            const rowNumber = document.getElementById('editRowNumber').value;
            const dataToUpdate = {
                action: "update", rowNumber: parseInt(rowNumber),
                data: {
                    "Nama Pegawai": document.getElementById('editNamaPegawai').value, "Nip Pegawai": document.getElementById('editNipPegawai').value,
                    "Nama Barang": document.getElementById('editNamaBarang').value, "Jumlah Barang": document.getElementById('editJumlahBarang').value,
                    "Tanggal Pengambilan": document.getElementById('editTanggal').value, "Waktu": document.getElementById('editWaktu').value
                }
            };

            fetch(WEB_APP_URL, {
                method: 'POST', body: JSON.stringify(dataToUpdate), headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    alert('Data berhasil diperbarui!');
                    showModal('editModal', false);
                    fetchDataPengawas(); 
                } else { throw new Error(result.message); }
            }).catch(error => { 
                alert('Gagal mengirim update: ' + error.message); 
                showLoading(false);
            });
        });

        async function deleteData(rowNumber) {
            showLoading(true);
            tableStatus.textContent = "Menghapus data...";
            tableStatus.style.display = 'block';

            const payload = { action: 'delete', rowNumber: parseInt(rowNumber) };

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Data berhasil dihapus!');
                    fetchDataPengawas();
                } else {
                    throw new Error(result.message || 'Gagal menghapus data.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                tableStatus.textContent = 'Gagal menghapus data: ' + error.message;
                showLoading(false);
            }
        }
        
        // --- LOGIKA PENGATURAN PASSWORD & EMAIL ---
        
        const settingsStatus = document.getElementById('settings-status');

        async function loadSettings() {
            showLoading(true);
            settingsStatus.textContent = '';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getSettings`);
                const result = await res.json();
                if (result.success) {
                    document.getElementById('emailPengawas').value = result.settings.pengawas_email || '';
                    document.getElementById('emailPegawai').value = result.settings.pegawai_email || '';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                settingsStatus.textContent = 'Gagal memuat email: ' + error.message;
                settingsStatus.style.color = 'var(--error-color)';
            } finally {
                showLoading(false);
            }
        }

        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true);
            settingsStatus.textContent = '';
            
            const role = document.getElementById('cpRole').value;
            const password = document.getElementById('cpNewPassword').value;

            const payload = { action: 'changePassword', role, password };

            fetch(WEB_APP_URL, {
                method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    settingsStatus.textContent = result.message;
                    settingsStatus.style.color = 'var(--success-color)';
                    document.getElementById('cpNewPassword').value = ''; 
                } else {
                    throw new Error(result.message);
                }
            }).catch(error => {
                settingsStatus.textContent = 'Gagal: ' + error.message;
                settingsStatus.style.color = 'var(--error-color)';
            }).finally(() => {
                showLoading(false);
                setTimeout(() => { settingsStatus.textContent = ''; }, 5000);
            });
        });

        document.getElementById('updateEmailsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true);
            settingsStatus.textContent = '';
            
            const payload = {
                action: 'updateEmails',
                pengawas_email: document.getElementById('emailPengawas').value,
                pegawai_email: document.getElementById('emailPegawai').value
            };

            fetch(WEB_APP_URL, {
                method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    settingsStatus.textContent = result.message;
                    settingsStatus.style.color = 'var(--success-color)';
                } else {
                    throw new Error(result.message);
                }
            }).catch(error => {
                settingsStatus.textContent = 'Gagal: ' + error.message;
                settingsStatus.style.color = 'var(--error-color)';
            }).finally(() => {
                showLoading(false);
                setTimeout(() => { settingsStatus.textContent = ''; }, 5000);
            });
        });

        // --- LOGIKA LUPA PASSWORD ---
        
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            showModal('forgotPasswordModal', true);
            document.getElementById('forgot-status').textContent = '';
            document.getElementById('forgotPasswordForm').reset();
        });

        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading(true);
            const status = document.getElementById('forgot-status');
            status.textContent = 'Mengirim email...';
            status.style.color = 'var(--text-muted)';

            const role = document.getElementById('fpRole').value;
            if (!role) {
                alert('Silakan pilih akun.');
                showLoading(false);
                return;
            }

            const payload = { action: 'forgotPassword', role };

            fetch(WEB_APP_URL, {
                method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            }).then(res => res.json()).then(result => {
                if (result.success) {
                    status.textContent = result.message;
                    status.style.color = 'var(--success-color)';
                    document.getElementById('forgotPasswordForm').reset();
                } else {
                    throw new Error(result.message);
                }
            }).catch(error => {
                status.textContent = 'Gagal: ' + error.message;
                status.style.color = 'var(--error-color)';
            }).finally(() => {
                showLoading(false);
            });
        });


        // --- FUNGSI DOWNLOAD (TIDAK BERUBAH) ---
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', async () => {
                if (currentData.length === 0) { return alert("Tidak ada data untuk di-download."); }
                
                showLoading(true);
                downloadPdfBtn.disabled = true; 
                downloadPdfBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mempersiapkan...';
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'landscape' });
                    const head = [['No', 'Nama Pegawai', 'NIP', 'Nama Barang', 'Jumlah', 'Tanggal', 'Waktu', 'Tanda Tangan']];
                    
                    const imagePromises = currentData.map(item => {
                        const signatureUrl = item['Tanda Tangan Penerima'];
                        if (signatureUrl && typeof signatureUrl === 'string' && signatureUrl.includes('drive.google.com')) {
                            try {
                                const fileId = new URL(signatureUrl).searchParams.get('id');
                                if (!fileId) return Promise.resolve(null);
                                return fetch(`${WEB_APP_URL}?action=getImageAsBase64&id=${fileId}`)
                                    .then(res => res.json())
                                    .then(result => result.success ? result.base64 : null)
                                    .catch(() => null);
                            } catch (e) { return Promise.resolve(null); }
                        } else { return Promise.resolve(null); }
                    });

                    const loadedImagesBase64 = await Promise.all(imagePromises);

                    const body = [];
                    currentData.forEach((item, index) => {
                        const rowData = [
                            index + 1, 
                            item['Nama Pegawai'], item['Nip Pegawai'], item['Nama Barang'], item['Jumlah Barang'],
                            item['Tanggal Pengambilan'], item['Waktu']
                        ];
                        
                        const imageData = loadedImagesBase64[index];
                        if (imageData) {
                            rowData.push({ image: imageData, width: 30, height: 15 });
                        } else {
                            rowData.push('Tidak Ada Ttd');
                        }
                        body.push(rowData);
                    });

                    const chunkSize = 8;
                    for (let i = 0; i < body.length; i += chunkSize) {
                        const chunk = body.slice(i, i + chunkSize);
                        if (i > 0) doc.addPage();
                        doc.setFontSize(16);
                        doc.text("Laporan Pengambilan Barang", 14, 15);
                        doc.autoTable({
                            head: head, 
                            body: chunk, 
                            startY: 22,
                            didDrawCell: function (data) {
                                if (data.column.index === 7 && data.cell.raw && data.cell.raw.image) {
                                    const img = data.cell.raw;
                                    const x = data.cell.x + (data.cell.width - img.width) / 2;
                                    const y = data.cell.y + (data.cell.height - img.height) / 2;
                                    doc.addImage(img.image, 'PNG', x, y, img.width, img.height);
                                }
                            },
                            columnStyles: { 7: { cellWidth: 40, minCellHeight: 20, halign: 'center', valign: 'middle' } }
                        });
                    }
                    
                    doc.save('laporan_pengambilan_barang.pdf');
                } catch (error) {
                    alert('Gagal membuat PDF: ' + error.message);
                } finally {
                    showLoading(false);
                    downloadPdfBtn.disabled = false; 
                    downloadPdfBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Download PDF';
                }
            });
        }
        
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        if (downloadCsvBtn) {
            downloadCsvBtn.addEventListener('click', () => {
                if (currentData.length === 0) { return alert("Tidak ada data untuk di-download."); }
                
                const csvData = currentData.map((row, index) => {
                    const { rowNumber, 'Tanda Tangan Penerima': ttd, ...rest } = row;
                    rest['No'] = index + 1;
                    const orderedRow = {
                        'No': rest['No'],
                        'Nama Pegawai': rest['Nama Pegawai'],
                        'Nip Pegawai': rest['Nip Pegawai'],
                        'Nama Barang': rest['Nama Barang'],
                        'Jumlah Barang': rest['Jumlah Barang'],
                        'Tanggal Pengambilan': rest['Tanggal Pengambilan'],
                        'Waktu': rest['Waktu']
                    };
                    return orderedRow;
                });
                
                const csv = Papa.unparse(csvData);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a"); 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "laporan_pengambilan_barang.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    </script>
</body>
</html>
